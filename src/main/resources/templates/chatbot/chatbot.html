<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
<meta charset="UTF-8">
<title>ChatBot Reciclaje</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
body {
	background-color: #e5ddd5;
	font-family: Arial, sans-serif;
}

.chat-container {
	max-width: 600px;
	margin: 30px auto;
	background-color: #fff;
	border-radius: 8px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	overflow: hidden;
	display: flex;
	flex-direction: column;
	height: 80vh;
}

.chat-header {
	background-color: #128C7E;
	color: white;
	padding: 15px;
	text-align: center;
	font-weight: bold;
}

.chat-body {
	flex: 1;
	padding: 15px;
	overflow-y: auto;
}

.message {
	margin-bottom: 12px;
	max-width: 80%;
	padding: 10px 15px;
	border-radius: 20px;
	position: relative;
}

.user-message {
	background-color: #DCF8C6;
	align-self: flex-end;
	margin-left: auto;
}

.bot-message {
	background-color: #ECE5DD;
	align-self: flex-start;
	margin-right: auto;
}

.timestamp {
	font-size: 10px;
	color: #777;
	margin-top: 4px;
	text-align: right;
}

.chat-footer {
	padding: 10px;
	background-color: #f0f0f0;
	display: flex;
}

.chat-footer input {
	flex: 1;
	border-radius: 20px;
	padding: 8px 15px;
	border: 1px solid #ccc;
}

.chat-footer button {
	margin-left: 10px;
}

/* Puedes agregar m√°s estilos si quieres */
</style>

<!-- CSRF para fetch AJAX -->
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<body>

	<div class="chat-container">
		<div class="chat-header">ü§ñ ChatBot de Reciclaje</div>

		<div class="chat-body" id="chatBody">
			<!-- Aqu√≠ se mostrar√°n los mensajes -->
		</div>

		<div class="chat-footer">
			<input type="text" id="mensajeInput"
				placeholder="Escribe tu mensaje..."
				onkeypress="if(event.key==='Enter') enviarMensaje()">
			<button class="btn btn-success" onclick="enviarMensaje()">Enviar</button>
		</div>
	</div>

	<div class="text-center mt-3">
		<a th:href="@{/usuarios/home}" class="btn btn-secondary">‚Üê Volver
			al Dashboard</a>
	</div>

	<script>
function enviarMensaje() {
    const mensajeInput = document.getElementById('mensajeInput');
    const mensaje = mensajeInput.value.trim();
    if (mensaje === "") return;

    const chatBody = document.getElementById('chatBody');
    const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

    // Mostrar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'message user-message';
    userMsg.innerHTML = mensaje + '<div class="timestamp">' + hora + '</div>';
    chatBody.appendChild(userMsg);
    chatBody.scrollTop = chatBody.scrollHeight;

    // Obtener token CSRF desde meta tags
    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/chatbot/enviar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [header]: token // Incluir token CSRF en el header
        },
        body: 'mensaje=' + encodeURIComponent(mensaje)
    })
    .then(response => response.json())
    .then(data => {
        console.log("DATA:", data); // ‚úÖ Esto te muestra qu√© devuelve el backend

        mensajeInput.value = '';

        const botMsg = document.createElement('div');
        botMsg.className = 'message bot-message';
        botMsg.innerHTML = data.respuesta + '<div class="timestamp">' + hora + '</div>';
        chatBody.appendChild(botMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
    })
    .catch(() => {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'message bot-message';
        errorMsg.innerHTML = '‚ö†Ô∏è Error al conectar con el bot<div class="timestamp">' + hora + '</div>';
        chatBody.appendChild(errorMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
    });
}

window.onload = () => {
    document.getElementById("mensajeInput").focus();
};
</script>

</body>
</html>
